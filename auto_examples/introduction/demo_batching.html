<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Computing motion energy features from batches of stimuli &mdash; pymoten 0.0.8 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=53b53b71"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Image coordinates" href="demo_image_coordinates.html" />
    <link rel="prev" title="Spatial components of the motion energy filters" href="demo_gabor_filters.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            pymoten
          </a>
              <div class="version">
                0.0.8
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Welcome to pymoten!</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Gallery of examples</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#motion-energy-pyramids">Motion energy pyramids</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Motion energy pyramids</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../autodoc/moten.html">moten package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../autodoc/moten.html#submodules">Submodules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../autodoc/moten.colorspace.html">moten.colorspace module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autodoc/moten.core.html">moten.core module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autodoc/moten.extras.html">moten.extras module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autodoc/moten.io.html">moten.io module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autodoc/moten.pyramids.html">moten.pyramids module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autodoc/moten.utils.html">moten.utils module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autodoc/moten.viz.html">moten.viz module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../autodoc/moten.html#module-moten">Module contents</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pymoten</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Gallery of examples</a></li>
          <li class="breadcrumb-item"><a href="index.html">Motion energy pyramids</a></li>
      <li class="breadcrumb-item active">Computing motion energy features from batches of stimuli</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/auto_examples/introduction/demo_batching.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-examples-introduction-demo-batching-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="computing-motion-energy-features-from-batches-of-stimuli">
<span id="sphx-glr-auto-examples-introduction-demo-batching-py"></span><h1>Computing motion energy features from batches of stimuli<a class="headerlink" href="#computing-motion-energy-features-from-batches-of-stimuli" title="Link to this heading"></a></h1>
<p>This example shows how to extract motion energy features from batches of a video.</p>
<p>When the stimulus is very high-resolution (e.g. 4K) or is several hours long, it might not be possible to fit load the stimulus into memory. In such situations, it is useful to load a small number of video frames and extract motion energy features from that subset of frames alone. In order to do this properly, one must avoid edge effects. In this example we show how to do that.</p>
<section id="features-from-stimulus">
<h2>Features from stimulus<a class="headerlink" href="#features-from-stimulus" title="Link to this heading"></a></h2>
<p>First, we specify the stimulus we want to load.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">moten</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">stimulus_fps</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">video_file</span> <span class="o">=</span> <span class="s1">&#39;http://anwarnunez.github.io/downloads/avsnr150s24fps_tiny.mp4&#39;</span>
</pre></div>
</div>
<p>Load the first 300 images and spatially downsample the video.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">small_vhsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">72</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>        <span class="c1"># height x width</span>
<span class="n">luminance_images</span> <span class="o">=</span> <span class="n">moten</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">video2luminance</span><span class="p">(</span><span class="n">video_file</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">small_vhsize</span><span class="p">,</span> <span class="n">nimages</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">nimages</span><span class="p">,</span> <span class="n">vdim</span><span class="p">,</span> <span class="n">hdim</span> <span class="o">=</span> <span class="n">luminance_images</span><span class="o">.</span><span class="n">shape</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vdim</span><span class="p">,</span> <span class="n">hdim</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">luminance_images</span><span class="p">[</span><span class="mi">200</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_demo_batching_001.png" srcset="../../_images/sphx_glr_demo_batching_001.png" alt="demo batching" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>72 128

[]
</pre></div>
</div>
<p>Next we construct the pyramid and extract the motion energy features from the full stimulus.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">pyramid</span> <span class="o">=</span> <span class="n">moten</span><span class="o">.</span><span class="n">pyramids</span><span class="o">.</span><span class="n">MotionEnergyPyramid</span><span class="p">(</span><span class="n">stimulus_vhsize</span><span class="o">=</span><span class="p">(</span><span class="n">vdim</span><span class="p">,</span> <span class="n">hdim</span><span class="p">),</span>
                                             <span class="n">stimulus_fps</span><span class="o">=</span><span class="n">stimulus_fps</span><span class="p">,</span>
                                             <span class="n">filter_temporal_width</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="n">moten_features</span> <span class="o">=</span> <span class="n">pyramid</span><span class="o">.</span><span class="n">project_stimulus</span><span class="p">(</span><span class="n">luminance_images</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">moten_features</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>(300, 2530)
</pre></div>
</div>
</section>
<section id="features-from-stimulus-batches">
<h2>Features from stimulus batches<a class="headerlink" href="#features-from-stimulus-batches" title="Link to this heading"></a></h2>
<p>Next, instead of computing the features from the full stimulus, we compute them from separate but continous stimulus chunks. These stimulus chunks are the stimulus batches.</p>
<p>We have to include some padding to the batches in order to avoid convolution edge effects. The padding is determined by the temporal width of the motion energy filter. By default, the temporal width is 2/3 of the stimulus frame rate (<cite>int(fps*(2/3))</cite>). This parameter can be specified when instantating a pyramid by passing e.g. <code class="docutils literal notranslate"><span class="pre">filter_temporal_width=16</span></code>. Once the pyramid is defined, the parameter can also be accessed from the <code class="docutils literal notranslate"><span class="pre">pyramid.definition</span></code> dictionary.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">filter_temporal_width</span> <span class="o">=</span> <span class="n">pyramid</span><span class="o">.</span><span class="n">definition</span><span class="p">[</span><span class="s1">&#39;filter_temporal_width&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Finally, we define the padding window as half the temporal filter width.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">window</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">filter_temporal_width</span><span class="o">/</span><span class="mi">2</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">filter_temporal_width</span><span class="p">,</span> <span class="n">window</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>16 8
</pre></div>
</div>
<p>Now we are ready to extract motion energy features in batches:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">nbatches</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nimages</span><span class="o">/</span><span class="n">nbatches</span><span class="p">))</span>
<span class="n">batched_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">bdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbatches</span><span class="p">):</span>
    <span class="n">start_frame</span><span class="p">,</span> <span class="n">end_frame</span> <span class="o">=</span> <span class="n">batch_size</span><span class="o">*</span><span class="n">bdx</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">*</span><span class="p">(</span><span class="n">bdx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Batch </span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1"> [</span><span class="si">%i</span><span class="s1">:</span><span class="si">%i</span><span class="s1">]&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">bdx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nbatches</span><span class="p">,</span> <span class="n">start_frame</span><span class="p">,</span> <span class="n">end_frame</span><span class="p">))</span>

    <span class="c1"># Padding</span>
    <span class="n">batch_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start_frame</span> <span class="o">-</span> <span class="n">window</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">batch_end</span> <span class="o">=</span> <span class="n">end_frame</span> <span class="o">+</span> <span class="n">window</span>
    <span class="n">stimulus_batch</span> <span class="o">=</span> <span class="n">luminance_images</span><span class="p">[</span><span class="n">batch_start</span><span class="p">:</span><span class="n">batch_end</span><span class="p">]</span>
    <span class="n">batched_responses</span> <span class="o">=</span> <span class="n">pyramid</span><span class="o">.</span><span class="n">project_stimulus</span><span class="p">(</span><span class="n">stimulus_batch</span><span class="p">)</span>

    <span class="c1"># Trim edges</span>
    <span class="k">if</span> <span class="n">bdx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">batched_responses</span> <span class="o">=</span> <span class="n">batched_responses</span><span class="p">[:</span><span class="o">-</span><span class="n">window</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">bdx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">nbatches</span><span class="p">:</span>
        <span class="n">batched_responses</span> <span class="o">=</span> <span class="n">batched_responses</span><span class="p">[</span><span class="n">window</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">batched_responses</span> <span class="o">=</span> <span class="n">batched_responses</span><span class="p">[</span><span class="n">window</span><span class="p">:</span><span class="o">-</span><span class="n">window</span><span class="p">]</span>
    <span class="n">batched_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batched_responses</span><span class="p">)</span>

<span class="n">batched_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">batched_data</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Batch 1/5 [0:60]
Batch 2/5 [60:120]
Batch 3/5 [120:180]
Batch 4/5 [180:240]
Batch 5/5 [240:300]
</pre></div>
</div>
<p>They are exactly the same.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">moten_features</span><span class="p">,</span> <span class="n">batched_data</span><span class="p">)</span>
</pre></div>
</div>
<p>In this example, the stimulus (<code class="docutils literal notranslate"><span class="pre">luminance_images</span></code>) is already in memory and so batching does not provide any benefits. However, there are situations in which the stimulus cannot be loaded all at once. In such situations, batching is necessary. One can modify the code above and write a function to load a subset of frames that can fit into memory (e.g. <code class="docutils literal notranslate"><span class="pre">stimulus_batch</span> <span class="pre">=</span> <span class="pre">load_my_video_frames_batch(`my_stimulus_video_file.avi`,</span> <span class="pre">batch_start,</span> <span class="pre">batch_end)</span></code>).</p>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 14.987 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-introduction-demo-batching-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/058e63c5da1393fd3437e5be2d1c72f9/demo_batching.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">demo_batching.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/6db5a74126c37b12cecb8d78ab7220d1/demo_batching.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">demo_batching.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/6caa0371c8777dbbe217fa63bddb5338/demo_batching.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">demo_batching.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="demo_gabor_filters.html" class="btn btn-neutral float-left" title="Spatial components of the motion energy filters" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="demo_image_coordinates.html" class="btn btn-neutral float-right" title="Image coordinates" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Anwar O. Nunez-Elizalde.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>